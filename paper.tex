\documentclass[11pt]{article}
\usepackage[hidelinks]{hyperref}
\usepackage{amsthm,amsmath,amsfonts,amssymb,amstext,mathtools}
\usepackage{fullpage}
\usepackage{macros}



\begin{document}

\title{An Air Drop That Preserves Recipient Privacy}
\author{Dan Boneh \and Riad Wahby}

\maketitle

\begin{abstract}
\end{abstract}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Introduction}

More to come.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Private air drop: definitions}


A private air drop (PAD) system is a triple of efficient algorithms:
\begin{itemize}
\item $\text{sendTokens}(\PK) \to (c, s)$:
Generates a token $c$ to be posted on the blockchain,
and a secret~$s$ given to the recipient via a private channel.
For example, an encryption of $s$ under $\PK$ can be posted
to the blockchain.   The posted encrypted $s$ is not associated with 
the token $c$. 

\item $\text{sign}(\SK, (c, s), m) \to \text{sig}$:
Signs a message $m$ indicating that the token $c$ is spent.

\item $\text{verify}(c, m, \text{sig}) \to \{\text{yes},\text{no}\}:$
Verify that a signature $\text{sig}$ on token $c$ is valid.
\end{itemize}

TODO: Need to state security properties formally: 
(1) $c$ and $\text{sig}$ should reveal nothing about $\PK$,
(2) without $\SK$ we have existential unforgeability under a 
(one-time) chosen message attack.


\subsection{Zero-knowledge proofs in generic groups}

TODO: Need overview of zero-knowledge in generic groups. 

\paragraph{The representation extraction lemma.}
Let $\adv$ be an algorithm that outputs 
a generic group element $u \in \GG$.
The following lemma shows that there is an extractor that
can extract from $\adv$ an integer representation of $u$
relative to a supplied set of group generators.
Moreover, this integer representation is unique.

\begin{lemma}[Unique representation extraction in generic groups]
\label{lem:unique}
Let $\adv_1, \adv_2$ be two randomized algorithms that interact
with generic group oracles for the group $\GG$ and 
output $u_1, u_2 \in \GG$, respectively. 
Suppose that each algorithm makes at most $q$ type-1 queries
and let $g_1,\ldots,g_q \in \GG$ be the returned random group elements. 

There is an extractor $\bdv$ that emulates 
the generic group oracles for $\adv_1$ and $\adv_2$
such that for $i=1,2$ when $\bdv$ interacts with $\adv_i$ 
the following holds with overwhelming probability:
if $\adv_i$ outputs $u_i \in \GG$ 
then the extractor $\bdv_i$ outputs a representation
$\alpha_{i,1},\ldots,\alpha_{i,q} \in \ZZ$
such that $u_i = g_1^{\alpha_{i,1}} \cdots g_q^{\alpha_{i,q}}$.
Moreover, if $u_1 = u_2$ then the two representations are the same,
namely $\alpha_{1,j} = \alpha_{2,j}$ for $j=1,\ldots,q$. 
\end{lemma}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{A private air drop to RSA public keys}

From here we use the following notations:
$\lambda$ is the security parameter (e.g., $\lambda = 128$), 
$\range{\ell}$ denotes the set of integers $\{0,1,\ldots,\ell-1\}$, and 
$\primes$ is a set of size $2^\lambda$ 
containing the smallest $2^\lambda$ odd primes. 
%
We will also need a set of public parameters that include the description
of a cyclic group $\GG$ of unknown order.  We let $g$ and $h$ be two
random generators of $\GG$ where the discrete-log of $g$ base $h$ is unknown. 

\subsection{Proving knowledge of the factorization of a hidden integer}

Let $n \in \range{N}$ be a secret integer 
where $N$ is a public upper bound on~$n$.
For simplicity we will also assume that $\abs{\GG} < N/2^{2 \lambda}$.
Let $c \deq g^n \cdot h^s \in \GG$ be a commitment to $n$, 
where $s \rgets \range{N}$.  
We first develop a zero knowledge protocol for proving knowledge of the
factorization of~$n$ given only $c$. 


To prove knowledge of the factorization of $n$ the prover
proves knowledge of a $w \in \range{N}$ such that $w^2 \equiv t \pmod{n}$
for some small public prime $t \in \ZZ$, namely $2 \leq t \leq \lambda$.
That is, we provide a ZKPK for the relation
\begin{equation} \label{eq:lang}
  {\cal R}_{g,h} \deq \left\{ \Bigl( (c, t) \in \GG \times \range{\lambda},\ \ 
                              (n, s, w, a) \in \range{N}^4 \Bigr)  \ \ 
        \text{s.t.}\ \ 
                \begin{split}
                        c   & = g^n \cdot h^s \ \ \text{in $\GG$}, \\
                        w^2 & = t + a \cdot n \ \ \text{in $\ZZ$}, \\
                        2 & \leq t \leq \lambda  \ \textrm{a prime}
                \end{split}  \right\}.
\end{equation}
Here $(c, t)$ is a statement and $(n, s, w, a)$ is a witness.
The integer relation $w^2 = t + a\cdot n$ proves that 
$w^2 \equiv t \pmod{n}$, as required.
We note that a ZKPK for~\eqref{eq:lang} proves that $t \in \ZZ$ is a quadratic
residue modulo the committed $n$.  Leaking this bit of information about $n$
does not interfere with the application to a secure air drop.

\medskip\noindent
Protocol $\prot{P}$: The ZKPK protocol for~\eqref{eq:lang} 
between the prover $P$ and the verifier $V$ works as follows:
\begin{itemize}
\item input:  the verifier has $(c, t) \in \GG \times \range{\lambda}$ and 
the prover has $(c, t, n, s, w, a) \in \GG \times \range{N}^5$  

\item Prover $P$ chooses a random integers $s_1, s_2 \rgets \range{N}$ and computes
       $c_1 \gets g^w \cdot h^{s_1} \in \GG$ and $c_2 \gets g^a \cdot h^{s_2}$.

\item Next, define a homomorphism $\phi:\ZZ^8 \to \GG^4 \times \ZZ$ 
parameterized by $g, h, c, c_1, c_2$ as follows:
\begin{equation} \label{eq:hom}
  \phi\left(\!\!\begin{array}{l}
                w, \mathit{w2}, s_1, a, \\
                \mathit{an}, \mathit{s1w}, \mathit{sa}, s_2
      \end{array}  \!\!\!\right) \deq
      \Bigl(\ 
       g^w \cdot h^{\mathit{s1}},\ \ \ 
       g^a \cdot h^{\mathit{s2}},\ \ \ 
       g^{\mathit{w2}} \cdot h^{\mathit{s1w}} / c_1^w,\ \ \ 
       g^{\mathit{an}} \cdot h^{\mathit{sa}} / c^a,\ \ \ 
       \mathit{w2} - \mathit{an}\ \Bigr)
\end{equation}
It is easy to see that $\phi$ is a group homomorphism.
The range of $\phi$ is the group $\GG^4 \times \ZZ$.  
We will write the group operation in this group multiplicatively.
That is, if $(a_i, b_i, c_i, d_i, e_i) \in \GG^4 \times \ZZ$ for $i=1,2$
then 
\[  (a_1, b_1, c_1, d_1, e_1) \cdot (a_2, b_2, c_2, d_2, e_2) \deq 
      (a_1 a_2,\ b_1 b_2,\ c_1 c_2,\ d_1 d_2,\ e_1 + e_2).  \]

We need a ZKPK for a $\phi$-preimage of 
$T \deq (c_1, c_2, 1, 1, t) \in \GG^4 \times \ZZ$. 
In other words, we need a zero-knowledge proof of knowledge for a vector 
$\vv' = (w', \mathit{w2}', s_1', a', \mathit{an}', 
              \mathit{s1w}', \mathit{sa}', s_2') \in \ZZ^8$ 
such that 
\[   \phi(\vv') = T = (c_1, c_2, 1, 1, t) \in \GG^4 \times \ZZ.  \]
Doing so proves 
that $c_1$ is a commitment to $w' \in \ZZ$, 
that $c_2$ is a commitment to $a' \in \ZZ$,
that $\mathit{w2}' = (w')^2$, and 
that $\mathit{an}' = a' \cdot n$ for some integer $a'$.
Then the last relation proves that $(w')^2 - a' \cdot n = t$ in $\ZZ$,
as required. 

We design a ZKPK for a $\phi$-preimage 
using a zero-knowledge protocol from~\cite[\S 3.5]{ourpaper}:
\begin{enumerate}
\item The prover chooses a random $\rv \rgets \range{N}^8$
and computes $\Rv \gets \phi(\rv) \in \GG^4 \times \ZZ$. \\
It sends $(c_1, c_2, \Rv)$ to the verifier.

\item The verifier chooses challenges $\mathit{ch} \rgets \range{2^\lambda}$
and $\ell \rgets \primes$. \\
It sends $(\ell, \mathit{ch})$ to the prover.

\item The prover computes:
\[  \zv \gets (\mathit{ch} \cdot \vv + \rv) \in \ZZ^8, \quad
    \zv_\ell \gets (\zv \bmod \ell) \in \range{\ell}^8, \quad
    \zv_q \gets \lfloor \zv / \ell \rfloor \in \ZZ^8, \quad
    \Zv_q \gets \phi(\zv_q)  
\]
and sends $(\Zv_q, \zv_\ell) \in (\GG^4 \times \ZZ) \times \range{\ell}^8$ 
to the verifier. 

\item The verifier accepts if 
$\ \Zv_q^\ell \cdot \phi(\zv_\ell) = T^\mathit{ch} \cdot \Rv\ $ in 
$\GG^4 \times \ZZ$.
\end{enumerate}
\end{itemize}

\paragraph{Comment 1.}
The commitment $c_2$ to the integer $a$ is necessary for soundness,
and in particular to ensure that $a$ is an integer.  If $c_2$ along
with $s_2$ and the second coordinate of $\phi$ are eliminated then there
is an attack where an adversarial prover can prove knowledge of
$(\sqrt{3} \bmod n)$ using $a = 1/n$ and $w = 2$.

\paragraph{Comment 2.}
There is a seemingly simpler method to prove that one knows the
factorization of~$n$, namely, prove that one knows $p$ such that $p$
divides $n$.  That is, instead of committing to $w$ we would commit to
$p$ and then prove that the committed value divides $n$. But we would
also need to prove that the committed factor is not one of 
$\{1, -1, n, -n\}$, and that results in a longer proof.

\paragraph{Proof of security.}
We need to prove the protocol above is zero-knowledge and a 
proof of knowledge. 

\begin{theorem}
Protocol $\prot{P}$ is a zero-knowledge protocol
for the relation ${\cal R}_{g,h}$ in \eqref{eq:lang}.
\end{theorem}

\begin{proof}
The simulator takes $(c, t)$ as input and outputs the simulated transcript
$(c_1, c_2, \Rv, \ell, \mathit{ch}, \Zv_q, \zv_\ell)$ as follows:
\begin{alg}
choose random $c_1, c_2 \rgets \GG,\ \ \ell \rgets \primes$, and
$\mathit{ch} \rgets \range{2^\lambda}$, \AlgSep
choose random $\zv_\ell \rgets \range{\ell}^8$ 
and random $Z_1,Z_2,Z_3,Z_4 \rgets \GG$ \AlgSep
choose $r_\text{w2}, r_\text{an} \rgets \range{N}$ and
set $Z_5 \gets \lfloor (r_\text{w2} - r_\text{an}) / \ell \rfloor \in \ZZ$, \AlgSep
set $\Zv_q \deq (Z_1, Z_2, Z_3, Z_4, Z_5) \in \GG^4 \times \ZZ$, \AlgSep
compute $\Rv \deq \Zv_q^\ell \cdot \phi(\zv_\ell) / T^\mathit{ch} \in \GG^4 \times \ZZ$. 
\end{alg}
We show the simulated transcript is distributed statistically close
to an accepting transcript of a real protocol execution.
First observe that $c_1, c_2, \Rv, \ell, \mathit{ch}$ are all distributed 
as in a real transcript.  It remains to show that the same holds
for $\zv_\ell$ and $\Zv_q$. 
In an interaction with a real prover 
the vector $\rv$ is chosen uniformly in $\range{N}^8$.
Consider one value $r \rgets \range{N}$.
Because $N$ is much larger than $\ell \cdot \abs{\GG}$
we know that the pair 
$\big((\lfloor r/\ell \rfloor \bmod \abs{\GG}),\ (r \bmod \ell) \big)$
is statistically close to uniform in $\range{\,\abs{\GG}\,} \times \range{\ell}$.
It directly follows that $\zv_\ell$ is statistically close to uniform 
in $\range{\ell}^8$, as in the simulation.
It also follows that $Z_1,Z_2,Z_3,Z_4 \in \GG$ are statistically close to 
uniform in $\GG$ because each of these four terms is randomized by
a fresh uniform randomizer,
$r_\text{s1}, r_\text{s2}, r_\text{w}, r_\text{a} \in \range{\,\abs{\GG}\,}$ respectively. 
Hence, these values are distributed as in
the simulation.
It remains to argue that $Z_5$ is simulated correctly. 
In the real protocol $Z_5$ is equal to
$\lfloor (t \cdot \mathit{ch} + r_\text{w2} - r_\text{an})/\ell \rfloor \in \ZZ$
plus or minus one.
Note that $(t \cdot \mathit{ch})/\ell$ is negligibly small compared
to $(r_\text{w2} - r_\text{an})/\ell$.
Hence, because in the real transcript $r_\text{w2}$ and $r_\text{an}$ 
are fresh uniform values in $\range{N}$, this $Z_5$ is distributed 
statistically close to its distribution in the simulation.
\end{proof}


We say that ${\cal G}$ is an honest instance
generator for the relation ${\cal R}_{g,h}$ in~\eqref{eq:lang}
if it chooses integers $n, s, t$, and outputs $(c, t)$ where
$c \deq g^n h^s \in \GG$. 

\begin{theorem}
Protocol $\prot{P}$ is an argument of knowledge
for the relation ${\cal R}_{g,h}$ in \eqref{eq:lang} with negligible
soundness error for instances $(c,t)$ generated by an honest instance
generator ${\cal G}$,
when $\GG$ is a modeled as a generic group of unknown order. 
\end{theorem}

\begin{proof}
We construct an extractor that given an instance $(c,t)$ 
generated by ${\cal G}$,
interacts with a convincing prover and outputs a witness $(n, s, w, a)$ 
for the relation ${\cal R}_{g,h}$ in~\eqref{eq:lang}. 
The protocol transcript is $(c_1, c_2, \Rv, \ell, \mathit{ch}, \Zv_q, \zv_\ell)$.
The extractor rewinds the prover and obtains two
accepting transcripts
${\cal T}_1 \deq (c_1, c_2, \Rv, \ell, \mathit{ch}, \Zv_q, \zv_\ell)$
and 
${\cal T}_2 \deq (c_1, c_2, \Rv, \ell, \mathit{ch}', \Zv_q', \zv_\ell')$.
Dividing the corresponding verification equations one by the other
we obtain
\[   (\Zv_q / \Zv_q')^\ell \cdot \phi(\zv_\ell - \zv_\ell') = 
          T^{\mathit{ch} - \mathit{ch}'}. \]
Let $\zv_\ell - \zv_\ell' = \Big(\Delta w,\ \Delta \mathit{w2},\ \Delta \mathit{s1},\ \Delta a,\ \Delta \mathit{an},\ \Delta \mathit{s1w},\ \Delta \mathit{sa},\ \Delta \mathit{s2} \Big) \in \ZZ^8$ and let $\Delta \mathit{ch} = \mathit{ch} - \mathit{ch}' \in \ZZ$.
Then plugging this into the definition of $\phi$ we obtain
\begin{equation} \label{eq:messy}
      (\Zv_q / \Zv_q')^\ell \cdot
      \left(\begin{array}{l}
       g^{\Delta w} \cdot h^{\Delta \mathit{s1}},\ \ \ 
       g^{\Delta a} \cdot h^{\Delta \mathit{s2}},\ \ \ 
       g^{\Delta \mathit{w2}} \cdot h^{\Delta \mathit{s1w}} / c_1^{\Delta w}, \\
       g^{\Delta \mathit{an}} \cdot h^{\Delta \mathit{sa}} / c^{\Delta a},\ \ \ 
       \Delta \mathit{w2} - \Delta \mathit{an}\ 
       \end{array} \right)
          = \left(\begin{array}{l}c_1, \ c_2, \ 1, \\ 1,\ t \end{array}\right)^{\Delta \mathit{ch}}.
\end{equation}
Let $\Zv_q / \Zv_q' = (z_1, z_2, z_3, z_4, z_5)$ 
where $z_1, z_2, z_3, z_4 \in \GG$ and $z_5 \in \ZZ$.  
In a generic group $\GG$, the group elements $z_1, z_2, z_3, z_4$ 
must satisfy $z_i = g^{\alpha_i} h^{\beta_i} c^{\gamma_i} \prod_{j=1}^q g_j^{\delta_{i,j}}$
for $i=1,2,3,4$, 
and $c_1 = g^{\alpha} h^{\beta} c^\gamma \prod_{j=1}^q g_j^{\delta_{j}}$,
and $c_2 = g^{\alpha_0} h^{\beta_0} c^\gamma \prod_{j=1}^q g_j^{\delta_{0,j}}$,
where the extractor knows all the listed integer exponents.
Here $g_1,\ldots,g_q \in \GG$ are random group elements produced in response
to a generic group oracle query for a random group element. 

It now follows from~\eqref{eq:messy}, and from $c = g^n h^s$, 
and by uniqueness of representation in generic groups (\Lemma{lem:unique}),
that the following equations must hold over the integers:
\begin{align*}
  \ell \cdot (\alpha_1 + n \cdot \gamma_1) + \Delta w & = (\alpha + n \cdot \gamma) \cdot \Delta \mathit{ch},  &
  \ell \cdot (\beta_1 + s \cdot \gamma_1) + \Delta \mathit{s1} & = (\beta + s \cdot \gamma) \cdot \Delta \mathit{ch}  
\\
  \ell \cdot (\alpha_2 + n \cdot \gamma_2) + \Delta a & = (\alpha_0 + n \cdot \gamma_0) \cdot \Delta \mathit{ch},  &
  \ell \cdot (\beta_2 + s \cdot \gamma_2) + \Delta \mathit{s2} & = (\beta_0 + s \cdot \gamma_0) \cdot \Delta \mathit{ch}  
\\
  \ell \cdot (\alpha_3 + n \cdot \gamma_3) + \Delta \mathit{w2} & = (\alpha + n \cdot \gamma) \cdot \Delta w,  &
  \ell \cdot (\beta_3 + s \cdot \gamma_3) + \Delta \mathit{s1w} & = (\beta + s \cdot \gamma) \cdot \Delta w   
\\
  \ell \cdot (\alpha_4 + n \cdot \gamma_4) + \Delta \mathit{an} & = n \cdot \Delta a,  & 
  \ell \cdot (\beta_4 + s \cdot \gamma_4) + \Delta \mathit{sa} & = s \cdot \Delta a   
\\
  \ell \cdot z_4 + \Delta \mathit{w2} - \Delta \mathit{an} & = t \cdot \Delta \mathit{ch} 
\end{align*}
The extractor knows all these values except for $n$ and $s$.
Reducing these equations modulo $\ell$ gives:
\begin{align}
  \Delta w & \equiv (\alpha + n \cdot \gamma) \cdot \Delta \mathit{ch}  &
  \Delta \mathit{s1} & \equiv (\beta + s \cdot \gamma) \cdot \Delta \mathit{ch}  & \pmod{\ell} 
\label{eq:first} \\
  \Delta a & \equiv (\alpha_0 + n \cdot \gamma_0) \cdot \Delta \mathit{ch}  &
  \Delta \mathit{s2} & \equiv (\beta_0 + s \cdot \gamma_0) \cdot \Delta \mathit{ch}  & \pmod{\ell} 
\label{eq:firsta} \\
  \Delta \mathit{w2} & \equiv (\alpha + n \cdot \gamma) \cdot \Delta w  &
  \Delta \mathit{s1w} & \equiv (\beta + s \cdot \gamma) \cdot \Delta w   & \pmod{\ell} 
\label{eq:second} \\
  \Delta \mathit{an} & \equiv n \cdot \Delta a  & 
  \Delta \mathit{sa} & \equiv s \cdot \Delta a   & \pmod{\ell} 
\label{eq:third} \\
  \Delta \mathit{w2} - \Delta \mathit{an} & \equiv t \cdot \Delta \mathit{ch} 
      &&& \pmod{\ell} 
\label{eq:fourth} 
\end{align}

Consider the left equalities in~\eqref{eq:first} and~\eqref{eq:firsta}.
Define $w \deq \alpha + n \cdot \gamma \in \ZZ$ 
and $a \deq \alpha_0 + n \cdot \gamma_0 \in \ZZ$.
For any pair of accepting transcripts such as $({\cal T}_1, {\cal T}_2)$,
it must be the case that 
$\Delta w \equiv w \cdot \Delta \mathit{ch} \pmod{\ell}$ and
$\Delta a \equiv a \cdot \Delta \mathit{ch} \pmod{\ell}$. 
The extractor knows $\Delta w,\ \Delta a$, and $\Delta \mathit{ch}$.
Hence, by constructing a polynomial number of such accepting transcript pairs, 
the extractor can recover $w, a \in \ZZ$ using the chinese remainder theorem. 

Next, consider the left equation in~\eqref{eq:second}.
Using $w = \alpha + n \cdot \gamma$ and
$\Delta w \equiv w \cdot \Delta \mathit{ch} \pmod{\ell}$ gives
$\Delta \mathit{w2} \equiv w^2 \cdot \Delta \mathit{ch} \pmod{\ell}$.

Using $\Delta \mathit{w2} \equiv w^2 \cdot \Delta \mathit{ch} \pmod{\ell}$
in~\eqref{eq:fourth}
gives $\Delta \mathit{an} \equiv (w^2 - t) \cdot \Delta \mathit{ch} \pmod{\ell}$. 
Finally, the left equality in~\eqref{eq:third} 
gives $(w^2 - t)\cdot \Delta \mathit{ch} \equiv n \cdot \Delta a \pmod{\ell}$.
Using $\Delta a \equiv a \cdot \Delta \mathit{ch} \pmod{\ell}$
we obtain that the extracted integers $w$ and $a$ must satisfy
$(w^2 - t)\cdot \Delta \mathit{ch} \equiv 
      n \cdot a \cdot \Delta \mathit{ch} \pmod{\ell}$.  
Since $\ell$ does not divide $\Delta \mathit{ch}$ with overwhelming
probability, we obtain that $w^2 - t \equiv n \cdot a \pmod{\ell}$.
Since this equality holds modulo a random $\ell \in \primes$ 
with overwhelming probability, 
the equality $w^2 - t = n \cdot a$ must hold over the integers,
as required.   Note that this implies that $a \neq 0$. 

Because $a \neq 0$, the extractor can obtain $(n \bmod \ell)$
from the left equality in~\eqref{eq:third}, and thus extract $n \in \ZZ$ by
repeating over several $\ell$.  Similarly, it can extract $s \in \ZZ$ from
the right equality in~\eqref{eq:third}.   
It thus obtains a witness $(n, s, w, a)$ 
for the relation ${\cal R}_{g,h}$ in~\eqref{eq:lang}, as required.
\end{proof}




\subsection{The concrete air drop system}

The air drop system is obtained by applying the Fiat-Shamir
heuristic to the protocol from the previous section. 
The concrete private air drop system works as follows:

\paragraph{Algorithm $\text{sendTokens}(\PK)$:}
To send tokens to an RSA public key $\PK = (n, e)$ do:
\begin{itemize}
\item 
generate a random $s \rgets \range{G}$.

\item 
output $(c, s)$ where $c \gets g^n \cdot h^s \in \GG$.
\end{itemize}

\medskip\noindent 
The following two notes can help optimize the scheme:
\begin{itemize}
\item[$-$] $s$ is privately sent to the owner of $\PK$, for example
by encrypting $s$ under $\PK$ to obtain a ciphertext $c'$ and
publishing this $c'$ somewhere, not necessarily on the blockchain.  There is
a public association between $c'$ and $\PK$ (e.g., via a hash table),
so that the owner of $\PK$ can easily find $c'$.  One can include
$H(c)$ in the plaintext encrypted in $c'$ to help the owner of $\PK$
quickly find $c$.  

\item[$-$] One can generate $s$ 
as $s \gets H(s')$ where $s'$ is a random 256-bit value and $H$ is a hash
function $H:\{0,1\}^{256} \to \range{G}$.  The ciphertext $c'$ is
an encryption of $s'$, instead of $s$, which can shrink~$c'$.
\end{itemize}


\paragraph{Algorithm $\text{sign}(\SK, (c, s), m)$:}  
To withdraw the funds associated with the token $c$ the user
signs a withdrawal message $m$ using the RSA secret key $\SK = (n,p,q)$ 
as follows:
\begin{itemize}
\item find a prime $2 \leq t \leq \lambda$  such that $t$ is a quadratic 
residue in $\ZZ_n$. 

\item find integers $(w,a)$ such that $w^2 = t + a n$ in $\ZZ$
           (i.e. $w$ is a square root of $t$ modulo $n$)

\item choose a random $s_1 \rgets \range{N}$ and compute
           $c_1 \gets g^w \cdot h^{s_1} \in \GG$.

\item choose a random $s_2 \rgets \range{N}$ and compute
           $c_2 \gets g^a \cdot h^{s_2} \in \GG$.

\item choose a random $\rv \rgets \range{N}^8$
and compute $\Rv \gets \phi(\rv) \in \GG^4 \times \ZZ$.

\item compute $\mathit{seed} \gets \text{Hash}(m, \GG, g, h, c, c_1, c_2, t, \Rv$).

\item
use a $\text{PRNG}(\mathit{seed})$ to generate $(\mathit{ch}, \ell)$, 
where $\mathit{ch} \in \range{2^\lambda}$ and $\ell \in \primes$.

\item compute:
\[  \xv \gets (\mathit{ch} \cdot \vv + \rv) \in \ZZ^8, \quad
    \zv_\ell \gets (\xv \bmod \ell) \in \range{\ell}^8, \quad
    \zv_q \gets \lfloor \xv / \ell \rfloor \in \ZZ^8, \quad
    \Zv_q \gets \phi(\zv_q) \in \GG^4 \times \ZZ.
\]

\item output the signature 
$\mathit{sig} = (c_1, c_2, t, \mathit{ch}, \ell, \Zv_q, \zv_\ell)$.
\end{itemize}



\paragraph{Algorithm $\text{verify}(c, m, \mathit{sig}):$}
Verify that $\mathit{sig} = (c_1, c_2, t, \mathit{ch}, \ell, \Zv_q, \zv_\ell)$ 
is a valid signature for token~$c$ on the message~$m$.
\begin{itemize}
\item reject if $t \notin \range{\lambda}$ or $t$ is not a prime.

\item with $T \deq (c_1, c_2, 1, 1, t) \in \GG^4 \times \ZZ$, 
compute $\Rv' \gets \Zv_q^\ell \cdot \phi(\zv_\ell) / T^\mathit{ch} \in \GG^4 \times \ZZ$.

\item compute $\mathit{seed}' \gets \text{Hash}(m, \GG, g, h, c, c_1, c_2, t, \Rv'$)

\item use a $\text{PRNG}(\mathit{seed}')$ to generate 
  $\mathit{ch}' \in \range{2^\lambda}$ and $\ell' \in \primes$. \\
Since $\ell$ is
  included in the signature, the verifier does not need to search for
  a prime, but can instead verify that the given $\ell$ is prime and
  is not too far from the base starting point of the prime search.

\item accept iff $\mathit{ch}' = \mathit{ch}$ and $\ell' = \ell$.
\end{itemize}



\paragraph{Comments.}
This scheme is only secure is a group where there are no known
elements of low order.  The group $\ZZ/n$ is not such a group because
of the element $-1$ of order $2$.  To eliminate this element we work
in the quotient group $(\ZZ/n)/\{\pm 1\}$, representing elements as
$\abs{x} = \min(x, n - x)$.  In this group $-1$ is the same as $1$,
and presumably there are no other known elements of known order.


\paragraph{Proof of security.}
We need to prove two things: 
(1) privacy in the random oracle model:
there is a simulator that can generate a properly distributed
signature just given $c$ and $m$, and 
(2) security: an attacker that is given $c$ along with a 
signature on some message $m$
with respect to $c$ and can generate a valid signature for $c$ on
some message $m' \neq m$ can be used to compute $\sqrt{t} \in \ZZ_n$
for some $2 \leq t \leq 1000$. 

\paragraph{Proof of privacy.}
TODO: Use the ZK proof of the interactive protocol. 


\paragraph{Proof of security.}
TODO: Use the extractor of the interactive protocol. 
 


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{A private air drop to ElGamal public keys}



\bibliographystyle{alpha}
\bibliography{paper}

\end{document}
